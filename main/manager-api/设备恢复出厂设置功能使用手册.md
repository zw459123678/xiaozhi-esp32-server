# 设备恢复出厂设置功能使用手册

## 1. 功能概述

设备恢复出厂设置功能允许用户清空指定设备的所有使用数据，让设备回到刚刚绑定时的初始状态。该功能可以选择性地清理聊天记录、声纹信息和智能体记忆，但**保持设备与智能体的绑定关系不变**。

## 2. 功能范围说明

### 2.1 会被清空的数据 ✨
| 数据类型 | 说明 | 可选择 |
|---------|------|--------|
| **聊天记录** | 该设备的所有对话历史 | ✅ 可选 |
| **聊天音频** | 与聊天记录关联的音频数据 | ✅ 随聊天记录一起清理 |
| **声纹信息** | 智能体的声纹识别数据 | ✅ 可选 |
| **智能体记忆** | summaryMemory 总结记忆内容 | ✅ 可选 |

### 2.2 会被保留的数据 🔒
| 数据类型 | 说明 | 原因 |
|---------|------|------|
| **设备绑定关系** | 设备与智能体的绑定 | 核心绑定关系保持 |
| **智能体基础配置** | 模型ID、系统提示等 | 基础配置不变 |
| **设备基本信息** | MAC地址、用户归属等 | 设备身份信息 |
| **用户权限** | 设备所有权 | 权限关系不变 |

## 3. 确认码机制

### 3.1 确认码作用
- 🛡️ **防误操作**: 重置是危险操作，确认码确保用户认真考虑
- 🔒 **安全验证**: 防止意外或恶意的批量重置
- 📝 **操作追踪**: 每个确认码对应一次明确的重置意图

### 3.2 确认码格式
- **格式**: `RESET_` + 至少6位字符
- **示例**: `RESET_123456`, `RESET_ABC123`, `RESET_20241212001`
- **生成**: 由前端/客户端生成（推荐使用时间戳或随机数）
- **验证**: 服务端检查格式和长度

```javascript
// 前端生成确认码示例
function generateResetConfirmationCode() {
    const timestamp = Date.now();
    return `RESET_${timestamp}`;
}
```

## 4. 完整使用流程

### 4.1 前端操作流程

#### 步骤1: 选择要重置的设备
```
用户操作：
1. 进入设备管理页面
2. 选择需要重置的设备（通过MAC地址标识）
3. 点击"恢复出厂设置"按钮
```

#### 步骤2: 配置重置选项
```
重置选项配置界面：
┌─────────────────────────────────────┐
│          设备恢复出厂设置            │
├─────────────────────────────────────┤
│ 设备：AA:BB:CC:DD:EE:FF             │
│ 智能体：小智助手                     │
│                                     │
│ 请选择要重置的内容：                 │
│ ☑️ 清空聊天记录（包括音频）          │
│ ☑️ 清空声纹信息                     │
│ ☑️ 重置智能体记忆                   │
│                                     │
│ 重置原因：                          │
│ [清理测试数据________________]       │
│                                     │
│    [取消]        [下一步]           │
└─────────────────────────────────────┘
```

#### 步骤3: 预验证（可选）
```javascript
// 调用预验证接口
const resetRequest = {
    macAddress: "AA:BB:CC:DD:EE:FF",
    confirmationCode: generateResetConfirmationCode(),
    reason: "清理测试数据",
    resetChatHistory: true,
    resetVoiceprint: true,
    resetMemory: true
};

fetch('/xiaozhi/device/reset/validate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(resetRequest)
})
.then(response => response.json())
.then(result => {
    if (result.code === 200) {
        // 验证通过，显示确认对话框
        showResetConfirmationDialog(resetRequest);
    } else {
        alert('验证失败：' + result.msg);
    }
});
```

#### 步骤4: 显示确认对话框
```
最终确认界面：
┌─────────────────────────────────────┐
│          ⚠️  重置确认                │
├─────────────────────────────────────┤
│ 设备：AA:BB:CC:DD:EE:FF             │
│ 智能体：小智助手                     │
│                                     │
│ 将要清空的内容：                     │
│ • 聊天记录和音频数据                 │
│ • 声纹识别信息                      │
│ • 智能体记忆                        │
│                                     │
│ ❗ 重要提醒：                       │
│ • 此操作将永久删除所选数据           │
│ • 设备与智能体的绑定关系保持不变     │
│ • 智能体基础配置不受影响            │
│ • 此操作不可撤销，请谨慎确认        │
│                                     │
│ 确认码：RESET_1703123456789         │
│ 重置原因：清理测试数据               │
│                                     │
│    [取消]        [确认重置]         │
└─────────────────────────────────────┘
```

#### 步骤5: 执行重置
```javascript
// 用户点击确认后，执行实际重置
fetch('/xiaozhi/device/reset', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(resetRequest)
})
.then(response => response.json())
.then(result => {
    if (result.code === 200) {
        alert('设备重置成功！');
        // 刷新设备状态
        refreshDeviceStatus();
    } else {
        alert('重置失败：' + result.msg);
    }
});
```

### 4.2 后端处理流程

#### 阶段1: 预验证（可选）
```
POST /xiaozhi/device/reset/validate

验证步骤：
1. ✅ 参数格式验证（MAC地址、确认码格式）
2. ✅ 设备存在性和权限检查
3. ✅ 智能体权限验证
4. ✅ 重置选项有效性检查
5. 📤 返回验证结果
```

#### 阶段2: 执行重置
```
POST /xiaozhi/device/reset

事务处理步骤：
1. 🔒 开启数据库事务
2. ✅ 重复执行所有验证逻辑
3. 📋 记录重置开始日志

如果选择清空聊天记录：
4. 🎵 清空聊天音频数据（先删除，因为依赖聊天记录）
5. 💬 清空聊天记录数据

如果选择清空声纹：
6. 🔊 清空声纹信息

如果选择重置记忆：
7. 🧠 重置智能体记忆（summaryMemory设为null）

8. 🗑️ 清理相关缓存
9. ✅ 提交事务
10. 📊 记录成功审计日志
```

## 5. API接口详细说明

### 5.1 预验证接口

**接口地址**: `POST /xiaozhi/device/reset/validate`

**请求参数**:
```json
{
    "macAddress": "AA:BB:CC:DD:EE:FF",          // 设备MAC地址（必填）
    "confirmationCode": "RESET_1703123456789",   // 重置确认码（必填）
    "reason": "清理测试数据",                    // 重置原因（可选）
    "resetChatHistory": true,                   // 是否清空聊天记录（默认true）
    "resetVoiceprint": true,                    // 是否清空声纹（默认true）
    "resetMemory": true                         // 是否重置记忆（默认true）
}
```

**响应示例**:
```json
// 成功
{
    "code": 200,
    "msg": "成功",
    "data": "验证通过，可以执行重置"
}

// 失败
{
    "code": 500,
    "msg": "设备不存在: AA:BB:CC:DD:EE:FF"
}
```

### 5.2 执行重置接口

**接口地址**: `POST /xiaozhi/device/reset`

**请求参数**: 与预验证接口相同

**响应示例**:
```json
// 成功
{
    "code": 200,
    "msg": "成功"
}

// 失败
{
    "code": 500,
    "msg": "恢复出厂设置失败: 设备未绑定智能体"
}
```

## 6. 错误码和异常处理

### 6.1 常见错误情况

| 错误信息 | 原因 | 解决方案 |
|---------|------|----------|
| `设备MAC地址格式不正确` | MAC地址格式错误 | 检查格式是否为 XX:XX:XX:XX:XX:XX |
| `重置确认码格式不正确` | 确认码不符合RESET_格式 | 使用正确格式生成确认码 |
| `设备不存在` | 指定MAC地址的设备不存在 | 检查设备是否已激活并属于当前用户 |
| `设备未绑定智能体` | 设备没有绑定任何智能体 | 该设备无需重置，或检查绑定状态 |
| `无权限操作该设备` | 当前用户不拥有该设备 | 确认设备归属关系 |
| `请至少选择一项要重置的内容` | 所有重置选项都为false | 至少选择一项要重置的内容 |

### 6.2 前端错误处理示例

```javascript
function handleResetError(error) {
    const errorHandlers = {
        '设备不存在': () => {
            alert('设备不存在，请检查设备是否已激活');
            refreshDeviceList();
        },
        '设备未绑定智能体': () => {
            alert('该设备未绑定智能体，无需重置');
        },
        '重置确认码格式不正确': () => {
            // 重新生成确认码
            regenerateResetConfirmationCode();
        },
        '请至少选择一项要重置的内容': () => {
            alert('请选择至少一项要重置的内容');
            // 回到选项配置界面
        }
    };
    
    const handler = errorHandlers[error.message];
    if (handler) {
        handler();
    } else {
        alert('重置失败：' + error.message);
    }
}
```

## 7. 安全和权限控制

### 7.1 权限要求
- **用户身份**: 必须是已登录的用户
- **设备权限**: 只能重置属于自己的设备
- **智能体权限**: 只能重置自己拥有的智能体
- **接口权限**: 需要 `sys:role:normal` 权限

### 7.2 操作审计
系统记录所有重置操作的详细日志：
```
[重置审计] 设备恢复出厂设置操作 - 用户ID: 123, 设备MAC: AA:BB:CC:DD:EE:FF, 
智能体ID: agent_123, 智能体名称: 小智助手, 
重置选项: [聊天记录:是, 声纹:是, 记忆:是], 原因: 清理测试数据, 结果: 成功, 
清理统计: 聊天音频: 15条, 聊天记录: 50条, 声纹信息: 3条, 智能体记忆: 已重置
```

## 8. 数据清理详细说明

### 8.1 清理顺序和依赖关系
```
1. 聊天音频数据 (ai_agent_chat_audio)
   ↓ (通过audioId关联)
2. 聊天记录数据 (ai_agent_chat_history) 
   ↓ (通过mac_address + agent_id)
3. 声纹信息 (ai_agent_voice_print)
   ↓ (通过agent_id)
4. 智能体记忆 (AgentEntity.summaryMemory)
   ↓
5. 相关缓存清理
```

### 8.2 数据统计信息
重置完成后，系统会提供详细的清理统计：
- **聊天音频**: X条记录
- **聊天记录**: X条记录  
- **声纹信息**: X条记录
- **智能体记忆**: 已重置/重置失败

## 9. 最佳实践建议

### 9.1 用户体验建议
1. **分步操作**: 将重置拆分为选择→验证→确认→执行的多步流程
2. **清晰提示**: 明确告知哪些数据会被删除，哪些会保留
3. **进度反馈**: 显示重置进度和完成状态
4. **结果展示**: 展示详细的清理统计信息

### 9.2 运维监控建议
1. **监控指标**: 重置成功率、失败原因分布、清理数据量统计
2. **告警机制**: 重置失败率异常时发送告警
3. **性能监控**: 监控大量数据清理的执行时间
4. **审计追踪**: 定期审计重置操作日志

### 9.3 数据安全建议
1. **操作前备份**: 重要数据在重置前进行备份
2. **分环境测试**: 在测试环境验证重置流程
3. **权限最小化**: 严格控制重置操作权限
4. **操作留痕**: 完整记录所有重置操作

## 10. 故障排除

### 10.1 重置失败处理
```
症状：重置操作失败或部分完成
排查步骤：
1. 检查数据库事务状态
2. 查看错误日志确定失败原因
3. 验证用户权限和设备状态
4. 检查数据依赖关系
5. 必要时手动清理残留数据
```

### 10.2 缓存不一致问题
```
症状：重置后页面显示旧数据
解决方案：
1. 手动清理相关Redis缓存
2. 刷新前端页面
3. 检查缓存键是否正确清理
```

### 10.3 数据恢复考虑
```
注意事项：
• 重置操作是不可逆的
• 如需恢复数据，只能从备份中恢复
• 建议在重要操作前进行数据备份
• 考虑实现软删除机制以支持数据恢复
```

## 11. 与其他功能的对比

| 功能 | 设备恢复出厂设置 | 智能体迁移 | 设备解绑 |
|------|------------------|------------|----------|
| **数据保留** | 绑定关系保持 | 数据完整迁移 | 完全解除绑定 |
| **使用场景** | 清理数据重新开始 | 设备更换 | 不再使用设备 |
| **操作难度** | 中等 | 高 | 简单 |
| **风险级别** | 高（数据丢失） | 中（迁移风险） | 低 |

---

**重要提醒**: 设备恢复出厂设置会永久删除选定的使用数据，操作前请确保已做好数据备份，并仔细确认操作范围。建议在测试环境充分验证后再在生产环境使用。