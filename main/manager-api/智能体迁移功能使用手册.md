# 智能体迁移功能使用手册

## 1. 功能概述

智能体迁移功能允许用户将一个设备上的智能体（包括所有聊天记录、声纹信息、配置等）完整迁移到另一个设备上。适用于设备丢失、损坏、更换等场景。

## 2. 确认码机制说明

### 2.1 确认码的作用
确认码是为了防止用户误操作而设计的安全机制。由于智能体迁移是一个**不可逆**的重要操作，会影响设备绑定关系和历史数据，因此需要用户明确确认。

### 2.2 确认码格式规则
- **格式**: `MIGRATE_` + 至少6位字符
- **示例**: `MIGRATE_123456`, `MIGRATE_ABC123`, `MIGRATE_20241212001`
- **生成方式**: 由前端或客户端生成（建议使用时间戳或随机数）
- **有效性**: 每次迁移请求都需要新的确认码

### 2.3 确认码验证逻辑
```java
// 服务端验证逻辑
public boolean isValidConfirmationCode(String confirmationCode) {
    return StringUtils.isNotBlank(confirmationCode) && 
           confirmationCode.startsWith("MIGRATE_") &&
           confirmationCode.length() >= 12; // MIGRATE_ + 至少6位
}
```

## 3. 完整使用流程

### 3.1 前端操作流程

#### 步骤1: 选择源设备和目标设备
```
用户操作：
1. 进入智能体管理页面
2. 选择要迁移的智能体所在的源设备（通过MAC地址标识）
3. 选择目标设备（必须是已激活但未绑定智能体的设备）
```

#### 步骤2: 生成确认码并预验证
```javascript
// 前端生成确认码示例
function generateConfirmationCode() {
    const timestamp = Date.now();
    return `MIGRATE_${timestamp}`;
}

// 调用预验证接口
const validateRequest = {
    sourceMacAddress: "AA:BB:CC:DD:EE:FF",
    targetMacAddress: "11:22:33:44:55:66",
    deleteSourceBinding: true,
    confirmationCode: generateConfirmationCode(),
    reason: "设备损坏需要更换"
};

fetch('/xiaozhi/agent/migrate/validate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(validateRequest)
})
```

#### 步骤3: 显示确认对话框
```
用户界面显示：
┌─────────────────────────────────────┐
│          智能体迁移确认              │
├─────────────────────────────────────┤
│ 源设备：AA:BB:CC:DD:EE:FF           │
│ 目标设备：11:22:33:44:55:66         │
│ 智能体：小智助手                     │
│                                     │
│ ⚠️  重要提醒：                       │
│ • 此操作将迁移所有聊天记录和配置     │
│ • 源设备将解除智能体绑定            │
│ • 此操作不可逆，请谨慎确认          │
│                                     │
│ 确认码：MIGRATE_1703123456789       │
│ 迁移原因：设备损坏需要更换           │
│                                     │
│    [取消]        [确认迁移]         │
└─────────────────────────────────────┘
```

#### 步骤4: 执行迁移
```javascript
// 用户点击确认后，执行实际迁移
fetch('/xiaozhi/agent/migrate', {
    method: 'POST', 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(validateRequest)
})
.then(response => response.json())
.then(result => {
    if (result.code === 200) {
        alert('智能体迁移成功！');
        // 刷新设备列表和智能体列表
    } else {
        alert('迁移失败：' + result.msg);
    }
});
```

### 3.2 后端处理流程

#### 阶段1: 预验证（可选）
```
POST /xiaozhi/agent/migrate/validate

处理步骤：
1. 参数格式验证（MAC地址、确认码格式）
2. 设备存在性检查
3. 权限验证（设备归属用户）
4. 业务规则检查（目标设备未绑定）
5. 返回验证结果
```

#### 阶段2: 执行迁移
```
POST /xiaozhi/agent/migrate

事务处理步骤：
1. 🔒 开启数据库事务
2. ✅ 重复执行所有验证逻辑
3. 📋 记录迁移开始日志
4. 🔄 更新目标设备绑定（绑定智能体）
5. 📝 迁移聊天记录（批量更新MAC地址）
6. 🧹 清空源设备绑定
7. 🗑️ 清理相关缓存
8. ✅ 提交事务
9. 📊 记录成功审计日志
```

#### 异常回滚机制
```
如果任何步骤失败：
1. 🔙 回滚数据库事务
2. ❌ 记录失败审计日志
3. 📤 返回具体错误信息给前端
```

## 4. API接口详细说明

### 4.1 预验证接口

**接口地址**: `POST /xiaozhi/agent/migrate/validate`

**请求参数**:
```json
{
    "sourceMacAddress": "AA:BB:CC:DD:EE:FF",      // 源设备MAC地址（必填）
    "targetMacAddress": "11:22:33:44:55:66",      // 目标设备MAC地址（必填）
    "deleteSourceBinding": true,                   // 是否删除源设备绑定（默认true）
    "confirmationCode": "MIGRATE_1703123456789",   // 确认码（必填）
    "reason": "设备损坏需要更换"                    // 迁移原因（可选）
}
```

**响应示例**:
```json
// 成功
{
    "code": 200,
    "msg": "成功",
    "data": "验证通过，可以执行迁移"
}

// 失败
{
    "code": 500,
    "msg": "目标设备已绑定智能体，请先解绑"
}
```

### 4.2 执行迁移接口

**接口地址**: `POST /xiaozhi/agent/migrate`

**请求参数**: 与预验证接口相同

**响应示例**:
```json
// 成功
{
    "code": 200,
    "msg": "成功"
}

// 失败
{
    "code": 500,
    "msg": "迁移操作失败: 源设备不存在: AA:BB:CC:DD:EE:FF"
}
```

## 5. 错误码和异常处理

### 5.1 常见错误情况

| 错误信息 | 原因 | 解决方案 |
|---------|------|----------|
| `源设备MAC地址格式不正确` | MAC地址不符合标准格式 | 检查MAC地址是否为 XX:XX:XX:XX:XX:XX 格式 |
| `确认码格式不正确` | 确认码不以MIGRATE_开头或长度不足 | 使用正确格式的确认码 |
| `源设备不存在` | 指定的源设备MAC地址在系统中不存在 | 检查源设备是否已激活并绑定到当前用户 |
| `目标设备已绑定智能体` | 目标设备已经绑定了其他智能体 | 先解绑目标设备，或选择其他目标设备 |
| `无权限操作源设备` | 当前用户不是源设备的拥有者 | 确认设备归属，联系管理员 |
| `源设备未绑定智能体` | 源设备没有绑定任何智能体 | 检查源设备状态 |

### 5.2 前端错误处理建议

```javascript
function handleMigrationError(error) {
    const errorHandlers = {
        '源设备不存在': () => {
            alert('源设备不存在，请检查设备是否已激活');
            // 刷新设备列表
        },
        '目标设备已绑定智能体': () => {
            if (confirm('目标设备已绑定智能体，是否先解绑？')) {
                // 调用解绑接口
                unbindTargetDevice();
            }
        },
        '确认码格式不正确': () => {
            // 重新生成确认码
            regenerateConfirmationCode();
        }
    };
    
    const handler = errorHandlers[error.message];
    if (handler) {
        handler();
    } else {
        alert('迁移失败：' + error.message);
    }
}
```

## 6. 安全和权限控制

### 6.1 权限要求
- **用户身份**: 必须是已登录的用户
- **设备权限**: 只能操作属于自己的设备
- **智能体权限**: 只能迁移属于自己的智能体
- **接口权限**: 需要 `sys:role:normal` 权限

### 6.2 操作审计
系统会记录所有迁移操作的详细日志：
```
[迁移审计] 智能体迁移操作 - 用户ID: 123, 源设备: AA:BB:CC:DD:EE:FF, 
目标设备: 11:22:33:44:55:66, 智能体ID: agent_123, 智能体名称: 小智助手, 
删除源绑定: true, 原因: 设备损坏需要更换, 结果: 成功
```

## 7. 最佳实践建议

### 7.1 前端UI/UX建议
1. **明确提示**: 在迁移前显示详细的影响说明
2. **二次确认**: 使用确认对话框防止误操作
3. **进度显示**: 显示迁移进度，因为可能涉及大量数据
4. **结果反馈**: 清晰地显示迁移结果和后续操作建议

### 7.2 运维监控建议
1. **监控指标**: 迁移成功率、失败原因统计、迁移耗时
2. **告警设置**: 迁移失败率过高时发送告警
3. **日志归档**: 定期归档迁移操作日志
4. **性能优化**: 监控大批量聊天记录迁移的性能

### 7.3 数据备份建议
1. **迁移前**: 建议先备份相关数据
2. **测试环境**: 在测试环境先验证迁移流程
3. **分批处理**: 对于有大量聊天记录的智能体，考虑分批迁移

## 8. 故障排除

### 8.1 迁移卡死问题
```
症状：迁移请求长时间无响应
排查：
1. 检查数据库连接状态
2. 查看是否有死锁
3. 检查聊天记录数量是否过大
4. 查看服务器内存使用情况
```

### 8.2 数据不一致问题
```
症状：迁移后数据显示异常
排查：
1. 检查Redis缓存是否正确清理
2. 验证聊天记录MAC地址是否正确更新
3. 确认设备绑定关系是否正确
4. 检查事务是否正确提交
```

### 8.3 回滚操作
```
如需手动回滚（谨慎操作）：
1. 恢复源设备的智能体绑定
2. 将聊天记录MAC地址改回源设备
3. 清空目标设备的智能体绑定
4. 清理相关缓存
5. 记录手动回滚操作日志
```

---

**重要提醒**: 智能体迁移是不可逆操作，建议在生产环境使用前充分测试，并确保有完善的备份和监控机制。